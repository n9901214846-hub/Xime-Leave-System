<!doctype html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>XIME Gate Pass</title>

  <style>
    :root{ --red:#b00020; --bg:#f6f6f8; --border:#e8e8ee; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: Arial, sans-serif; background:var(--bg); color:#111; }
    .wrap{ max-width:720px; margin:24px auto; padding:0 16px; }
    .card{
      background:#fff; border:1px solid var(--border);
      border-radius:16px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.06);
      position:relative; overflow:hidden;
    }
    .header{
      display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap;
      border-bottom:1px solid var(--border); padding-bottom:12px; margin-bottom:14px;
    }
    .title{ font-weight:900; color:var(--red); font-size:16px; }
    .sub{ font-weight:800; font-size:13px; color:#333; margin-top:3px; }
    .id{ font-size:12px; color:#666; font-weight:800; }
    .stamp{
      position:absolute; top:18px; right:18px;
      border:3px solid #0a7a18; color:#0a7a18;
      padding:10px 14px; border-radius:12px;
      font-weight:1000; letter-spacing:1px;
      transform: rotate(8deg);
      background:rgba(233,255,240,.7);
    }
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media(max-width:650px){ .grid{ grid-template-columns:1fr; } }
    .box{
      border:1px solid var(--border); border-radius:14px; padding:12px;
      background:#fff;
    }
    .label{ font-size:12px; color:#666; font-weight:800; }
    .value{ font-size:15px; font-weight:900; margin-top:4px; color:#111; }
    .approvers{
      margin-top:12px; border-top:1px solid var(--border); padding-top:12px;
    }
    .row{ display:flex; justify-content:space-between; gap:10px; padding:10px 0; border-bottom:1px dashed #eee; }
    .row:last-child{ border-bottom:none; }
    .pill{
      padding:6px 10px; border-radius:999px; font-weight:900; font-size:12px;
      border:1px solid #ddd;
    }
    .approved{ background:#e9fff0; color:#0a7a18; border-color:#bff1c9; }
    .muted{ color:#666; font-size:12px; font-weight:800; }
    .warn{
      background:#fff1f1; border:1px dashed #ffb9c2; color:#8b0013;
      padding:12px; border-radius:14px; font-weight:900;
    }
    .printbar{ margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; }
    .btn{
      padding:10px 12px; border-radius:12px; border:none; cursor:pointer; font-weight:900;
    }
    .btn.red{ background:var(--red); color:#fff; }
    .btn.gray{ background:#fff; color:#111; border:1px solid var(--border); }
  </style>
</head>

<body>
  <div class="wrap">
    <div id="content" class="card">
      Loading gate pass…
    </div>
  </div>

  <script type="module">
    import { auth, db } from "./firebase.js";
    import { onAuthStateChanged } from "firebase/auth";
    import { doc, getDoc } from "firebase/firestore";

    const content = document.getElementById("content");
    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");

    function esc(s){ return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    function approverRows(map){
      const entries = Object.entries(map || {});
      if (!entries.length) return `<div class="muted">No approver info.</div>`;
      return entries.map(([email, d]) => {
        const name = d.name || email;
        const decision = d.decision || "Pending";
        const cls = decision === "Approved" ? "pill approved" : "pill";
        return `
          <div class="row">
            <div>
              <div style="font-weight:900">${esc(name)}</div>
              <div class="muted">${esc(email)}</div>
            </div>
            <div class="${cls}">${esc(decision)}</div>
          </div>
        `;
      }).join("");
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) { window.location.href = "index.html"; return; }
      if (!id) {
        content.innerHTML = `<div class="warn">Missing gate pass ID.</div>`;
        return;
      }

      const snap = await getDoc(doc(db, "leave_requests", id));
      if (!snap.exists()) {
        content.innerHTML = `<div class="warn">Gate pass not found.</div>`;
        return;
      }

      const r = snap.data();

      if (r.finalStatus !== "Approved") {
        content.innerHTML = `
          <div class="header">
            <div>
              <div class="title">XIME Gate Pass</div>
              <div class="sub">Students Leave Portal</div>
            </div>
            <div class="id">Req ID: ${esc(id)}</div>
          </div>
          <div class="warn">Gate pass is available only after final approval (both approvers Approved).</div>
          <div class="muted" style="margin-top:10px;">
            Current Status: <b>${esc(r.finalStatus || "Pending")}</b>
          </div>
        `;
        return;
      }

      content.innerHTML = `
        <div class="stamp">APPROVED</div>

        <div class="header">
          <div>
            <div class="title">Xavier Institute of Management and Entrepreneurship, Chennai</div>
            <div class="sub">Students Leave Portal – Gate Pass</div>
          </div>
          <div class="id">Req ID: ${esc(id)}</div>
        </div>

        <div class="grid">
          <div class="box">
            <div class="label">Student Name</div>
            <div class="value">${esc(r.studentName)}</div>
            <div class="muted">${esc(r.studentEmail)}</div>
          </div>

          <div class="box">
            <div class="label">Batch / Hostel</div>
            <div class="value">${esc(r.batch)} / ${esc(r.hostel)}</div>
          </div>

          <div class="box">
            <div class="label">Out (Leaving campus)</div>
            <div class="value">${esc(r.outDate)} ${esc(r.outTime)}</div>
          </div>

          <div class="box">
            <div class="label">In (Returning to campus)</div>
            <div class="value">${esc(r.inDate)} ${esc(r.inTime)}</div>
          </div>
        </div>

        <div class="box" style="margin-top:12px;">
          <div class="label">Reason</div>
          <div class="value" style="font-size:14px; font-weight:800;">${esc(r.reason)}</div>
        </div>

        <div class="approvers">
          <div style="font-weight:900; color:var(--red); margin-bottom:8px;">Approvals</div>
          ${approverRows(r.approverDecisions)}
        </div>

        <div class="printbar">
          <button class="btn red" onclick="window.print()">Print / Screenshot</button>
          <button class="btn gray" onclick="window.location.href='student.html'">Back</button>
        </div>
      `;
    });
  </script>
</body>
</html>
